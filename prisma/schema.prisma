generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  ACCOUNTANT
  PARENT
  STUDENT
}

enum SchoolLevel {
  PRIMARY
  SECONDARY
}

enum SubjectCategory {
  CORE
  ELECTIVE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REVERSED
}

model Tenant {
  id                 String      @id @default(uuid())
  name               String
  registrationNumber String?
  contactEmail       String
  phone              String?
  address            String?
  logoUrl            String?
  subscriptionId     String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  subscription       Subscription? @relation(fields: [subscriptionId], references: [id])
  users              User[]
  academicYears      AcademicYear[]
  classes            Class[]
  streams            Stream[]
  parents            Parent[]
  students           Student[]
  teachers           Teacher[]
  tenantSubjects     TenantSubject[]
  exams              Exam[]
  gradingRules       GradingRule[]
  feeStructures      FeeStructure[]
  invoices           Invoice[]
  notifications      Notification[]
  policies           AcademicPolicy[]
}

model Subscription {
  id           String             @id @default(uuid())
  planName     String
  maxStudents  Int
  priceMonthly Decimal            @db.Decimal(10, 2)
  priceYearly  Decimal            @db.Decimal(10, 2)
  features     Json
  status       SubscriptionStatus

  tenants      Tenant[]
}

model User {
  id           String   @id @default(uuid())
  tenantId     String?
  firstName    String
  lastName     String
  email        String
  passwordHash String
  phone        String?
  isActive     Boolean  @default(true)
  lastLogin    DateTime?
  userType     UserType
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant?  @relation(fields: [tenantId], references: [id])
  userRoles    UserRole[]
  auditLogs    AuditLog[]

  @@unique([tenantId, email])
}

model Role {
  id              String            @id @default(uuid())
  name            String            @unique
  description     String?
  userRoles       UserRole[]
  rolePermissions RolePermission[]
}

model Permission {
  id              String            @id @default(uuid())
  code            String            @unique
  description     String?
  rolePermissions RolePermission[]
}

model UserRole {
  userId String
  roleId String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model AcademicYear {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  isActive  Boolean  @default(false)
  startsOn  DateTime
  endsOn    DateTime

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  terms     Term[]
}

model Term {
  id             String   @id @default(uuid())
  academicYearId String
  name           String
  startsOn       DateTime
  endsOn         DateTime

  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  enrollments    Enrollment[]
  exams          Exam[]
}

model Class {
  id             String      @id @default(uuid())
  tenantId       String
  name           String
  level          SchoolLevel
  orderNumber    Int

  tenant         Tenant       @relation(fields: [tenantId], references: [id])
  streams        Stream[]
  students       Student[]
  enrollments    Enrollment[]
  classSubjects  ClassSubject[]
  teacherAssignments TeacherAssignment[]
}

model Stream {
  id       String @id @default(uuid())
  tenantId String
  classId  String
  name     String

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  class    Class  @relation(fields: [classId], references: [id])
  students Student[]
}

model MasterSubject {
  id             String @id @default(uuid())
  name           String
  code           String @unique
  level          SchoolLevel
  nectaCode      String?
  category       SubjectCategory
  active         Boolean @default(true)

  tenantSubjects TenantSubject[]
  nectaMappings  NectaMapping[]
}

model TenantSubject {
  id              String @id @default(uuid())
  tenantId        String
  masterSubjectId String
  isActive        Boolean @default(true)

  tenant          Tenant @relation(fields: [tenantId], references: [id])
  masterSubject   MasterSubject @relation(fields: [masterSubjectId], references: [id])
  marks           Mark[]
  classSubjects   ClassSubject[]
  teacherAssignments TeacherAssignment[]

  @@unique([tenantId, masterSubjectId])
}

model ClassSubject {
  id              String @id @default(uuid())
  classId         String
  tenantSubjectId String

  class           Class @relation(fields: [classId], references: [id])
  tenantSubject   TenantSubject @relation(fields: [tenantSubjectId], references: [id])

  @@unique([classId, tenantSubjectId])
}

model Parent {
  id         String   @id @default(uuid())
  tenantId   String
  fullName   String
  phone      String
  email      String?
  occupation String?

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  students   Student[]
}

model Student {
  id              String   @id @default(uuid())
  tenantId        String
  admissionNumber String
  firstName       String
  lastName        String
  gender          String
  dateOfBirth     DateTime
  classId         String
  streamId        String?
  parentId        String?
  status          String
  enrollmentDate  DateTime

  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  class           Class    @relation(fields: [classId], references: [id])
  stream          Stream?  @relation(fields: [streamId], references: [id])
  parent          Parent?  @relation(fields: [parentId], references: [id])
  marks           Mark[]
  invoices        Invoice[]
  enrollments     Enrollment[]
  computedResults ComputedResult[]
  rankings        Ranking[]

  @@unique([tenantId, admissionNumber])
}

model Teacher {
  id         String @id @default(uuid())
  tenantId   String
  firstName  String
  lastName   String
  email      String
  phone      String?

  tenant     Tenant @relation(fields: [tenantId], references: [id])
  assignments TeacherAssignment[]

  @@unique([tenantId, email])
}

model Enrollment {
  id        String @id @default(uuid())
  studentId String
  classId   String
  termId    String
  status    String

  student   Student @relation(fields: [studentId], references: [id])
  class     Class   @relation(fields: [classId], references: [id])
  term      Term    @relation(fields: [termId], references: [id])

  @@unique([studentId, termId])
}

model TeacherAssignment {
  id              String @id @default(uuid())
  teacherId       String
  classId         String
  tenantSubjectId String

  teacher         Teacher @relation(fields: [teacherId], references: [id])
  class           Class   @relation(fields: [classId], references: [id])
  tenantSubject   TenantSubject @relation(fields: [tenantSubjectId], references: [id])

  @@unique([teacherId, classId, tenantSubjectId])
}

model Exam {
  id          String  @id @default(uuid())
  tenantId    String
  termId      String
  name        String
  weightCa    Decimal @db.Decimal(5, 2)
  weightExam  Decimal @db.Decimal(5, 2)
  published   Boolean @default(false)

  tenant      Tenant @relation(fields: [tenantId], references: [id])
  term        Term   @relation(fields: [termId], references: [id])
  marks       Mark[]
  computedResults ComputedResult[]
  rankings    Ranking[]
}

model GradingRule {
  id         String @id @default(uuid())
  tenantId   String
  minScore   Int
  maxScore   Int
  grade      String
  gradePoint Int?

  tenant     Tenant @relation(fields: [tenantId], references: [id])
}

model Mark {
  id              String @id @default(uuid())
  examId          String
  studentId       String
  tenantSubjectId String
  caScore         Decimal @db.Decimal(5, 2)
  examScore       Decimal @db.Decimal(5, 2)
  totalScore      Decimal? @db.Decimal(5, 2)
  grade           String?
  gradePoint      Decimal? @db.Decimal(4, 2)
  approved        Boolean @default(false)

  exam            Exam @relation(fields: [examId], references: [id])
  student         Student @relation(fields: [studentId], references: [id])
  tenantSubject   TenantSubject @relation(fields: [tenantSubjectId], references: [id])

  @@unique([examId, studentId, tenantSubjectId])
}

model ComputedResult {
  id          String @id @default(uuid())
  studentId   String
  examId      String
  average     Decimal @db.Decimal(5, 2)
  gpa         Decimal? @db.Decimal(4, 2)
  division    String?
  position    Int?
  payload     Json

  student     Student @relation(fields: [studentId], references: [id])
  exam        Exam @relation(fields: [examId], references: [id])

  @@unique([studentId, examId])
}

model Ranking {
  id          String @id @default(uuid())
  examId      String
  classId     String
  studentId   String
  position    Int

  exam        Exam @relation(fields: [examId], references: [id])
  class       Class @relation(fields: [classId], references: [id])
  student     Student @relation(fields: [studentId], references: [id])

  @@unique([examId, classId, studentId])
}

model FeeStructure {
  id          String @id @default(uuid())
  tenantId    String
  classId     String
  name        String
  amount      Decimal @db.Decimal(12, 2)

  tenant      Tenant @relation(fields: [tenantId], references: [id])
  class       Class @relation(fields: [classId], references: [id])
  invoices    Invoice[]
}

model Invoice {
  id             String @id @default(uuid())
  tenantId       String
  studentId      String
  feeStructureId String?
  amount         Decimal @db.Decimal(12, 2)
  balanceDue     Decimal @db.Decimal(12, 2)
  dueDate        DateTime
  status         InvoiceStatus
  createdAt      DateTime @default(now())

  tenant         Tenant @relation(fields: [tenantId], references: [id])
  student        Student @relation(fields: [studentId], references: [id])
  feeStructure   FeeStructure? @relation(fields: [feeStructureId], references: [id])
  payments       Payment[]

  @@index([tenantId, status])
}

model Payment {
  id                String @id @default(uuid())
  invoiceId         String
  amount            Decimal @db.Decimal(12, 2)
  paymentMethod     String
  referenceNumber   String
  status            PaymentStatus
  paidAt            DateTime?

  invoice           Invoice @relation(fields: [invoiceId], references: [id])
  transactions      PaymentTransaction[]
}

model PaymentTransaction {
  id                String @id @default(uuid())
  paymentId         String?
  provider          String
  providerReference String
  eventType         String
  payload           Json
  status            String
  createdAt         DateTime @default(now())

  payment           Payment? @relation(fields: [paymentId], references: [id])

  @@unique([provider, providerReference, eventType])
}

model AuditLog {
  id         String @id @default(uuid())
  userId     String?
  action     String
  entity     String
  entityId   String
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now())

  user       User? @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id         String @id @default(uuid())
  tenantId   String?
  actorId    String?
  action     String
  metadata   Json?
  createdAt  DateTime @default(now())
}

model Notification {
  id         String @id @default(uuid())
  tenantId   String
  userId     String?
  channel    String
  subject    String?
  message    String
  status     String
  createdAt  DateTime @default(now())

  tenant     Tenant @relation(fields: [tenantId], references: [id])
}

model AcademicPolicy {
  id                   String @id @default(uuid())
  tenantId             String
  gradingScale         Json
  passingMark          Int
  promotionRule        Json
  maxSubjectsAllowed   Int
  rankingEnabled       Boolean @default(true)
  attendanceThreshold  Int
  divisionEnabled      Boolean @default(false)
  gpaEnabled           Boolean @default(false)

  tenant               Tenant @relation(fields: [tenantId], references: [id])
}

model NectaMapping {
  id              String @id @default(uuid())
  masterSubjectId String
  nectaCode       String
  level           SchoolLevel

  masterSubject   MasterSubject @relation(fields: [masterSubjectId], references: [id])
}
